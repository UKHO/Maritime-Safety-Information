parameters:
  - name: AzureSubscription
    type: string

steps:
    - task: DownloadBuildArtifacts@0
      displayName: "Download Integration test Artifact"
      inputs:
       buildType: 'current'
       downloadType: 'single'
       artifactName: 'IntegrationTests'
       downloadPath: '$(Build.SourcesDirectory)'

    - task: DownloadBuildArtifacts@0
      displayName: "Download terraformartifact Artifact"
      inputs:
       buildType: 'current'
       downloadType: 'single'
       artifactName: 'terraformartifact'
       downloadPath: '$(Build.SourcesDirectory)'

    - task: FileTransform@1
      displayName: "File Transform: integrationtests"
      inputs:
       folderPath: '$(Build.SourcesDirectory)/IntegrationTests/'
       fileType: json
       targetFiles: '**/appsettings.json'

    - task: UseDotNet@2
      displayName: 'Use .NET 6.0.x sdk'
      inputs:
       packageType: sdk
       version: 6.0.x

    - task: DotNetCoreCLI@2
      displayName: "Run Integration tests"
      inputs:
       command: "test"
       projects: |
          **/*IntegrationTest*.dll
          !**/*TestAdapter.dll
          !**/obj/**
       testRunTitle: "$(Environment)-IntegrationTests"
       workingDirectory: '$(Build.SourcesDirectory)/IntegrationTests'

    - checkout: self

    - task: NodeTool@0
      inputs:
       versionSpec: '14.x'
      displayName: 'Install Node.js'

    - script: |
       npm ci
      displayName: 'npm restore'
      workingDirectory: '$(Build.SourcesDirectory)/Tests'

    - task: FileTransform@1
      inputs:
       folderPath: '$(Build.SourcesDirectory)\Tests\Configuration'
       fileType: 'json'
       targetFiles: 'appConfig.json'

    - script: |
       npm run test:auto
      displayName: 'Run Functional Tests'
      workingDirectory: '$(Build.SourcesDirectory)/Tests/AutoTests/FunctionalTest'

    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testRunner: 'JUnit'
        testResultsFiles: 'results.xml'
        mergeTestResults: true
        searchFolder:  '$(System.DefaultWorkingDirectory)\Tests'
        testRunTitle: $(Environment) Functional Test Results
      displayName: 'Publish Functional Test Results'

    - task: PowerShell@2
      condition: always()
      inputs:
       targetType: 'inline'
       script: |
         ls
         ls .\Deployment\

    - task: AzureCLI@2
      displayName: "Swap MSI BusinessUnit"
      condition: always()
      inputs:
        azureSubscription: "${{ parameters.AzureSubscription }}"
        scriptType: 'pscore'
        scriptLocation: 'scriptPath'
        scriptPath: "$(System.DefaultWorkingDirectory)/Deployment/set_business_unit.ps1"
        arguments: '-businessUnit $(FileShareService.BusinessUnitMsi) -resourceGroup $(webapp_rg) -webappName $(WEB_APP_NAME)'

    - script: |
       npm run test:a11y
      displayName: 'Run Accessibility Tests'
      workingDirectory: '$(Build.SourcesDirectory)/Tests/AutoTests/AccessibilityTest'
          
    - task: PublishTestResults@2
      condition: succeededOrFailed()
      inputs:
        testRunner: 'JUnit'
        testResultsFiles: 'results.xml'
        mergeTestResults: true
        searchFolder:  '$(System.DefaultWorkingDirectory)\Tests'
        testRunTitle: $(Environment) Accessibility Test Results
      displayName: 'Publish Accessibility Test Results'

    
