parameters:
  - name: ContinueEvenIfResourcesAreGettingDestroyed
    type: boolean
    default: false
  - name: AzureSubscription
    type: string

steps:
  - task: FileTransform@1
    displayName: "File Transform: Msi Config" #Replace msi instance value from pipeline 
    inputs:
      folderPath: '$(Pipeline.Workspace)/terraformartifact/src'
      fileType: 'json'
      targetFiles: 'appsettings.json'

  - task: PowerShell@2
    displayName: "terraform $(Environment)deploy"
    name: TerraformDeploy
    inputs:
      targetType: filePath
      filePath: '$(Pipeline.Workspace)/terraformartifact/terraform_conditional_run.ps1'
      arguments: '-deploymentResourceGroupName MSIDev-RG -deploymentStorageAccountName msidevsa -workSpace $(Environment) -continueEvenIfResourcesAreGettingDestroyed $${{ parameters.ContinueEvenIfResourcesAreGettingDestroyed }} -terraformJsonOutputFile $(Pipeline.Workspace)/terraformartifact/terraform_output.json'
    env:
      ARM_CLIENT_ID: $(TERRAFORM-CLIENT-ID)
      ARM_CLIENT_SECRET: $(TERRAFORM-CLIENT-SECRET)
      ARM_TENANT_ID: $(TERRAFORM-TENANT-ID)
      ARM_SUBSCRIPTION_ID: $(TERRAFORM-SUBSCRIPTION-ID)

  - task: DownloadPipelineArtifact@2
    displayName: "Download Dackpack Artifact"
    inputs:
      source: "current"
      artifact: "Dackpack"
      path: $(Build.SourcesDirectory)/Dackpack

  - task: SqlAzureDacpacDeployment@1
    inputs:
      azureSubscription: "SharedServicesPre"
      AuthenticationType: "aadAuthenticationPassword"
      ServerName: $(RNW_DB_Server)
      DatabaseName: $(RNW_DB_Name)
      aadSqlUsername: $(RNW_DB_Deploy_User)
      aadSqlPassword: $(RNW_DB_Deploy_Pass)
      deployType: "DacpacTask"
      DeploymentAction: "Publish"
      IpDetectionMethod: "AutoDetect"
      DacpacFile: $(Build.SourcesDirectory)/Dackpack/UKHO.MaritimeSafetyInformation.Web.Database.dacpac

  - task: FileTransform@1
    displayName: "File Transform: WebAppSettings"
    inputs:
      folderPath: '$(Pipeline.Workspace)/MaritimeSafetyInformation/*.zip'
      fileType: 'json'
      targetFiles: '**/appsettings.json'

  - task: AzureWebApp@1
    displayName: "Azure App Deploy: msi-$(Environment)-webapp"
    inputs:
      azureSubscription: "${{ parameters.AzureSubscription }}"
      appType: webApp
      appName: "$(WEB_APP_NAME)"
      package: "$(Pipeline.Workspace)/MaritimeSafetyInformation/UKHO.MaritimeSafetyInformation.Web.zip"

  - task: PowerShell@2
    displayName: "Check the status of Service"
    inputs:
      targetType: filePath
      filePath: "$(Pipeline.Workspace)/terraformartifact/check_service_status.ps1"
      arguments: "-healthEndPointUrl $(MsiWebUrl)/health -waitTimeInMinute $(waitTimeInMinute)"
